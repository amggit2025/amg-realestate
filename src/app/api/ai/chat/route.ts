import { NextRequest, NextResponse } from 'next/server'
import { GoogleGenerativeAI } from '@google/generative-ai'
import { prisma } from '@/lib/db'

export async function POST(request: NextRequest) {
  try {
    const { message, history } = await request.json()

    if (!message || !message.trim()) {
      return NextResponse.json(
        { success: false, error: 'Message is required' },
        { status: 400 }
      )
    }

    // Check API key
    const apiKey = process.env.GOOGLE_AI_API_KEY
    if (!apiKey) {
      console.error('Missing GOOGLE_AI_API_KEY environment variable')
      return NextResponse.json(
        { success: false, error: 'ุฎุทุฃ ูู ุฅุนุฏุงุฏุงุช ุงูุฎุงุฏู. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู' },
        { status: 500 }
      )
    }

    // Initialize Gemini AI
    const genAI = new GoogleGenerativeAI(apiKey)

    // Get recent properties for context
    const recentListings = await prisma.listings.findMany({
      take: 15,
      where: {
        status: 'APPROVED'
      },
      orderBy: { createdAt: 'desc' },
      select: {
        title: true,
        price: true,
        address: true,
        city: true,
        governorate: true,
        bedrooms: true,
        bathrooms: true,
        area: true,
        propertyType: true,
        description: true
      }
    })

    // Get featured projects
    const featuredProjects = await prisma.projects.findMany({
      take: 5,
      where: {
        featured: true,
        published: true
      },
      orderBy: { createdAt: 'desc' },
      select: {
        title: true,
        description: true,
        location: true,
        developer: true,
        minPrice: true,
        maxPrice: true,
        bedrooms: true,
        area: true,
        projectType: true,
        deliveryDate: true
      }
    })

    // Get portfolio items (ูุนุฑุถ ุงูุฃุนูุงู)
    const portfolioItems = await prisma.portfolio_items.findMany({
      take: 8,
      where: {
        featured: true,
        published: true
      },
      orderBy: { createdAt: 'desc' },
      select: {
        title: true,
        description: true,
        location: true,
        category: true,
        area: true,
        completionDate: true
      }
    })

    // Get services (ุงูุฎุฏูุงุช)
    const services = await prisma.services.findMany({
      where: {
        published: true
      },
      orderBy: { order: 'asc' },
      select: {
        title: true,
        titleAr: true,
        description: true,
        descriptionAr: true,
        category: true,
        features: true
      }
    })

    // Build AI context with real estate data
    const propertiesContext = recentListings.length > 0
      ? recentListings.map(p => `
- ${p.title}
  ุงูููุน: ${getPropertyTypeArabic(p.propertyType)}
  ุงูุณุนุฑ: ${formatPrice(Number(p.price))}
  ุงููููุน: ${p.city}, ${p.governorate}
  ${p.bedrooms ? `ุนุฏุฏ ุงูุบุฑู: ${p.bedrooms}` : ''}
  ${p.bathrooms ? `ุนุฏุฏ ุงูุญูุงูุงุช: ${p.bathrooms}` : ''}
  ${p.area ? `ุงููุณุงุญุฉ: ${p.area}ูยฒ` : ''}
`).join('\n')
      : 'ูุง ุชูุฌุฏ ุนูุงุฑุงุช ูุชุงุญุฉ ุญุงููุงู.'

    // Build projects context
    const projectsContext = featuredProjects.length > 0
      ? featuredProjects.map(p => `
- ${p.title}
  ุงููุทูุฑ: ${p.developer || 'ุบูุฑ ูุญุฏุฏ'}
  ุงููููุน: ${p.location}
  ุงูููุน: ${p.projectType || 'ูุดุฑูุน ุณููู'}
  ${p.minPrice ? `ุงูุณุนุฑ ูู: ${formatPrice(Number(p.minPrice))}` : ''}
  ${p.maxPrice ? ` ุฅูู ${formatPrice(Number(p.maxPrice))}` : ''}
  ${p.area ? `ุงููุณุงุญุงุช ูู: ${p.area}` : ''}
  ${p.deliveryDate ? `ุงูุชุณููู: ${p.deliveryDate}` : ''}
  ุงููุตู: ${p.description || ''}
`).join('\n')
      : ''

    // Build portfolio context
    const portfolioContext = portfolioItems.length > 0
      ? portfolioItems.map(p => `
- ${p.title} (${p.category || 'ูุดุฑูุน ุนูุงุฑู'})
  ุงููููุน: ${p.location || 'ูุตุฑ'}
  ${p.area ? `ุงููุณุงุญุฉ: ${p.area}` : ''}
  ${p.completionDate ? `ุชู ุงูุชูููุฐ: ${new Date(p.completionDate).getFullYear()}` : ''}
  ${p.description ? `ุงูุชูุงุตูู: ${p.description.substring(0, 150)}...` : ''}
`).join('\n')
      : ''

    // Build services context
    const servicesContext = services.length > 0
      ? services.map(s => `
- ${s.titleAr || s.title}
  ุงููุฆุฉ: ${s.category || 'ุฎุฏูุงุช ุนูุงุฑูุฉ'}
  ุงููุตู: ${s.descriptionAr || s.description || ''}
  ${s.features ? `ุงููููุฒุงุช: ${JSON.parse(s.features).slice(0, 3).join('ุ ')}` : ''}
`).join('\n')
      : ''

    // Build conversation history
    const conversationHistory = history && history.length > 0
      ? history.map((msg: any) => `${msg.sender === 'user' ? 'ุงูุนููู' : 'ุงููุณุงุนุฏ'}: ${msg.text}`).join('\n')
      : ''

    // Create AI prompt
    const prompt = `
ุฃูุช ุฃุญูุฏุ ุงููุณุงุนุฏ ุงูุนูุงุฑู ุงูุฐูู ูุดุฑูุฉ AMG ููุงุณุชุซูุงุฑ ุงูุนูุงุฑู ูู ูุตุฑ.
ุดุฎุตูุชู: ูุฏูุฏุ ูุญุชุฑูุ ูุฎุจูุฑ ูู ุงูุนูุงุฑุงุช ุงููุตุฑูุฉ ูุงูุณูู ุงูุนูุงุฑู ุจุดูู ุนุงู.

๐ข ูุนูููุงุช ุนู ุดุฑูุฉ AMG:
- ุงูุงุณู ุงููุงูู: AMG ููุงุณุชุซูุงุฑ ุงูุนูุงุฑู
- ุณููุงุช ุงูุฎุจุฑุฉ: ุฃูุซุฑ ูู 15 ุณูุฉ ูู ุงูุณูู ุงููุตุฑู
- ุงูุชุฎุตุตุงุช: ุจูุน ูุชุณููู ูุฅุฏุงุฑุฉ ูุชุทููุฑ ุนูุงุฑู
- ุงูููุงุทู ุงูุฑุฆูุณูุฉ: ุงููุงูุฑุฉ ุงูุฌุฏูุฏุฉุ ุงูุชุฌูุน ุงูุฎุงูุณ (1ู3ู5)ุ ุงูุดูุฎ ุฒุงูุฏุ 6 ุฃูุชูุจุฑุ ุงูุนุงุตูุฉ ุงูุฅุฏุงุฑูุฉ ุงูุฌุฏูุฏุฉุ ุงูุณุงุญู ุงูุดูุงูู
- ุงูุฎุฏูุงุช ุงููุงููุฉ: 
  * ุจูุน ูุดุฑุงุก ุฌููุน ุฃููุงุน ุงูุนูุงุฑุงุช
  * ุฅุฏุงุฑุฉ ูุชุณููู ุนูุงุฑู ุงุญุชุฑุงูู
  * ุงุณุชุดุงุฑุงุช ุนูุงุฑูุฉ ูุงุณุชุซูุงุฑูุฉ
  * ุชุณูููุงุช ุชูููู ุนูุงุฑู ูุน ุงูุจููู
  * ุฎุฏูุงุช ุงูุชุดุทูุจุงุช ูุงูุฏูููุฑ
  * ุฎุฏูุฉ ูุง ุจุนุฏ ุงูุจูุน
- ุงูุชูุงุตู: ูุงุชุณุงุจ 01000025080 | info@amg-invest.com
- ุงูุนููุงู: ูุตุฑ - ุงููุงูุฑุฉ

๐ ุงูุนูุงุฑุงุช ุงููุชุงุญุฉ ุญุงููุงู ูู ูุงุนุฏุฉ ุจูุงูุงุชูุง:
${propertiesContext}

${projectsContext ? `๐๏ธ ุงููุดุงุฑูุน ุงููููุฒุฉ ุงูุชู ูุฏูุฑูุง:
${projectsContext}
` : ''}

${portfolioContext ? `โจ ูู ูุนุฑุถ ุฃุนูุงููุง ุงูุณุงุจูุฉ (ูุดุงุฑูุน ูููุฐุฉ):
${portfolioContext}
` : ''}

${servicesContext ? `๐ง ุฎุฏูุงุชูุง ุงููุชูุงููุฉ:
${servicesContext}
` : ''}

๐ **ูุธุงู ุงูุฅุฌุงุจุฉ ุงููุฎุชูุท:**
- **ุฃููุงู**: ุงุณุชุฎุฏู ุงูุนูุงุฑุงุช ูุงููุดุงุฑูุน ูุงูุฎุฏูุงุช ุงููุชุงุญุฉ ุฃุนูุงู ุฅุฐุง ูุงูุช ุชูุงุณุจ ุทูุจ ุงูุนููู
- **ุซุงููุงู**: ุฅุฐุง ูู ุชุฌุฏ ุนูุงุฑ ููุงุณุจ ุฃู ุณุฃู ุนู ูุนูููุงุช ุนุงูุฉุ ุงุณุชุฎุฏู ูุนุฑูุชู ุงูุนุงูุฉ ุนู:
  * ุงูุณูู ุงูุนูุงุฑู ุงููุตุฑู (ุฃุณุนุงุฑุ ููุงุทูุ ุงุชุฌุงูุงุช)
  * ุงูููุงุทู ุงูุฌุฏูุฏุฉ ูุงููุดุฑูุนุงุช ุงููุจุฑู ูู ูุตุฑ
  * ูุตุงุฆุญ ุงูุงุณุชุซูุงุฑ ุงูุนูุงุฑู
  * ุงููุนูููุงุช ุงููุงููููุฉ ูุงูุฅุฌุฑุงุฆูุฉ ุงูุนุงูุฉ
  * ููุงุฑูุงุช ุจูู ุงูููุงุทู ุงูุณูููุฉ
- **ููุงุญุธุฉ ูููุฉ**: ุนูุฏ ุงูุฅุฌุงุจุฉ ูู ูุนุฑูุชู ุงูุนุงูุฉุ ูุถูุญ ููุนููู ุฃูู ุชุชุญุฏุซ ุนู ุงูุณูู ุจุดูู ุนุงู

${conversationHistory ? `ูุญุงุฏุซุฉ ุณุงุจูุฉ:\n${conversationHistory}\n` : ''}

ุงูุฑุณุงูุฉ ุงูุญุงููุฉ ูู ุงูุนููู:
${message}

ุฅุฑุดุงุฏุงุช ุงูุชูุงุตู ูุน ุงูุนููุงุก:

๐ **ุฃุณุงุณูุงุช ุงููุญุงุฏุซุฉ:**
1. ุงุจุฏุฃ ุฏุงุฆูุงู ุจุชุฑุญูุจ ูุฏูุฏ ูุณุคุงู ุนู ุงุญุชูุงุฌุงุช ุงูุนููู
2. ุงุณุชุฎุฏู ุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู ุงููุจุณุทุฉ ูุน ุจุนุถ ุงูุชุนุจูุฑุงุช ุงูุฏุงุฑุฌุฉ ุงููุตุฑูุฉ
3. ูู ููุฌุฒุงู ููุจุงุดุฑุงู (2-4 ุฃุณุทุฑ ูุญุฏ ุฃูุตู ููุฑุฏ)
4. ุงุณุชุฎุฏู ุงูุฅูููุฌู ุจุดูู ูุนุชุฏู ูุฌุนู ุงููุญุงุฏุซุฉ ุฃูุซุฑ ุญูููุฉ ๐โจ

๐ฏ **ููู ุงุญุชูุงุฌุงุช ุงูุนููู:**
- ุงุณุฃู ุนู: ุงูููุฒุงููุฉุ ุงูููุทูุฉ ุงูููุถูุฉุ ููุน ุงูุนูุงุฑุ ุนุฏุฏ ุงูุบุฑูุ ุงูุบุฑุถ (ุณูู/ุงุณุชุซูุงุฑ)
- ุฅุฐุง ุฐูุฑ ููุทูุฉ: ุงูุชุฑุญ ููุงุทู ุจุฏููุฉ ูุฑูุจุฉ ููุดุงุจูุฉ
- ุฅุฐุง ุฐูุฑ ููุฒุงููุฉ: ุงูุชุฑุญ ุนูุงุฑุงุช ูู ูุทุงู ยฑ20% ูู ุงูููุฒุงููุฉ

๐ก **ุนุฑุถ ุงูุนูุงุฑุงุช (ุงููุธุงู ุงููุฎุชูุท):**
- **ุฃููููุฉ 1**: ุงุนุฑุถ ุงูุนูุงุฑุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุฃุนูุงู ุฅุฐุง ูุงูุช ููุงุณุจุฉ
- **ุฃููููุฉ 2**: ุฅุฐุง ูู ุชุฌุฏ ุนูุงุฑ ููุงุณุจุ ุงุณุชุฎุฏู ูุนุฑูุชู ุนู ุงูุณูู:
  * ุฃุฎุจุฑ ุงูุนููู ุนู ูุชูุณุท ุงูุฃุณุนุงุฑ ูู ุงูููุทูุฉ ุงููุทููุจุฉ
  * ุงูุชุฑุญ ููุงุทู ุจุฏููุฉ ุจูุงุกู ุนูู ููุฒุงููุชู
  * ูุฏู ูุตุงุฆุญ ุนุงูุฉ ุนู ุงูุงุณุชุซูุงุฑ ูู ุงูููุทูุฉ
  * ูุถูุญ ุฃูู ุชุชุญุฏุซ ุนู ุงูุณูู ุงูุนุงู ูููุณ ุนูุงุฑุงุช ูุญุฏุฏุฉ ุนูุฏูุง
- ุนูุฏ ุงูุนุฑุถ: ุงุฐูุฑ ุงูููุนุ ุงูุณุนุฑุ ุงููููุนุ ุงููุณุงุญุฉุ ุนุฏุฏ ุงูุบุฑู
- ุฃุจุฑุฒ ุงููููุฒุงุช ุงููุฑูุฏุฉ ููู ุนูุงุฑ
- ุงุนุฑุถ 2-3 ุนูุงุฑุงุช ูุญุฏ ุฃูุตู ูู ูู ุฑุฏ

๐ **ุงุณุชุฎุฏุงู ุงููุนุฑูุฉ ุงูุนุงูุฉ:**
ููููู ุงูุฅุฌุงุจุฉ ุนูู:
- "ุฅูู ุฃูุถู ููุงุทู ููุณูู ูู ุงููุงูุฑุฉุ" โ ุงุณุชุฎุฏู ูุนุฑูุชู ุงูุนุงูุฉ
- "ุฃุณุนุงุฑ ุงูุดูู ูู ุงูุดูุฎ ุฒุงูุฏ ุฅููุ" โ ูุฏู ูุทุงู ุงูุฃุณุนุงุฑ ุงูุนุงู + ุนูุงุฑุงุชูุง
- "ุฅูู ุงููุฑู ุจูู ุงูุชุฌูุน ุงูุฎุงูุณ ูุงูุดูุฎ ุฒุงูุฏุ" โ ูุนูููุงุช ุนุงูุฉ ููุงุฑูุฉ
- "ุฅุฒุงู ุฃุดุชุฑู ุดูุฉ ุจุงูุชูุณูุทุ" โ ุดุฑุญ ุนุงู + ุฎุฏูุงุชูุง
- "ุงูุนุงุตูุฉ ุงูุฅุฏุงุฑูุฉ ูููุง ุฅููุ" โ ูุนูููุงุช ุนุงูุฉ ุนู ุงููุดุฑูุน
- ุนูุฏ ุงูุฅุฌุงุจุฉ ูู ูุนุฑูุชู ุงูุนุงูุฉุ ูู: "ุจุดูู ุนุงู ูู ุงูุณูู..." ุฃู "ุญุณุจ ูุนุฑูุชู ุจุงูุณูู..."
- ุงุฐูุฑ: ุงูููุนุ ุงูุณุนุฑุ ุงููููุนุ ุงููุณุงุญุฉุ ุนุฏุฏ ุงูุบุฑู
- ุฃุจุฑุฒ ุงููููุฒุงุช ุงููุฑูุฏุฉ ููู ุนูุงุฑ
- ูุงุฑู ุจูู ุงูุฎูุงุฑุงุช ุจุดูู ููุถูุนู

๐ฐ **ุงูุชูููู ูุงูุฃุณุนุงุฑ:**
- ุงูุชูููู ุงูุนูุงุฑู: ูุชุงุญ ูู ุงูุจููู ุงููุตุฑูุฉ ุจูุงุฆุฏุฉ 8-12%
- ููุฏู: ุนุงุฏุฉ 20-25% ูู ูููุฉ ุงูุนูุงุฑ
- ูุฏุฉ ุงูุณุฏุงุฏ: ุญุชู 20 ุณูุฉ
- ุฃูุธูุฉ ุงูุฏูุน: ูุงุดุ ุชูุณูุท ุฏุงุฎููุ ุชูููู ุจููู

๐ฃ๏ธ **ุฃุณููุจ ุงูุญุฏูุซ:**
- ุงุณุชุฎุฏู ุนุจุงุฑุงุช ูุซู: "ุจูู ุชุฃููุฏ"ุ "ููุชุงุฒ"ุ "ุงุฎุชูุงุฑ ูููู"ุ "ุฏุนูู ุฃุณุงุนุฏู"
- ุชุฌูุจ: ุงููุบุฉ ุงููุนูุฏุฉุ ุงููุตุทูุญุงุช ุงูุชูููุฉ ุงูุตุนุจุฉุ ุงูุฑุฏูุฏ ุงูุทูููุฉ
- ูู ุฅูุฌุงุจูุงู ููุชุญูุณุงู ุฏุงุฆูุงู
- ุงุฎุชู ูู ุฑุฏ ุจุณุคุงู ุฃู ุฏุนูุฉ ููุชูุงุตู

๐ **ุงูุชูุงุตู ูุงููุชุงุจุนุฉ:**
- ุฅุฐุง ุฃุจุฏู ุงูุนููู ุงูุชูุงูุงู ุฌุงุฏุงู: ุงูุชุฑุญ ุงูุชูุงุตู ูุน ูุฑูู ุงููุจูุนุงุช
- ุฑูู ุงููุงุชุณุงุจ: 01000025080
- ููุงุณุชูุณุงุฑุงุช ุงูุชูุตูููุฉ: ุฃุญูู ุงูุนููู ูููุฑูู ุงููุชุฎุตุต
- ูุฏู ุฎุฏูุฉ ุฌุฏููุฉ ูุนุงููุงุช ููุนูุงุฑุงุช

โ๏ธ **ุงูุญุงูุงุช ุงูุฎุงุตุฉ:**
- **ูู ุชุฌุฏ ุนูุงุฑ ููุงุณุจ**: ุงุณุชุฎุฏู ูุนุฑูุชู ุงูุนุงูุฉ ุนู ุงูุณูู + ุงูุชุฑุญ ุชุนุฏูู ุงููุนุงููุฑ ุฃู ุงูุชูุงุตู ูุนูุง
- **ุณุคุงู ุนู ููุทูุฉ ูุง ุนูุฏูุงุด ูููุง ุนูุงุฑุงุช**: ูุฏู ูุนูููุงุช ุนุงูุฉ ุนู ุงูููุทูุฉ ูุฃุณุนุงุฑูุง
- **ุณุคุงู ุนุงู ุนู ุงูุนูุงุฑุงุช**: ุงุณุชุฎุฏู ูุนุฑูุชู ุงูุนุงูุฉ ุจุญุฑูุฉ
- **ุณุคุงู ุฎุงุฑุฌ ุงูุนูุงุฑุงุช**: ูุฌููู ุจูุทู ููููุถูุน ุฃู ูุฏู ุฅุฌุงุจุฉ ูุฎุชุตุฑุฉ ุซู ุงุฑุฌุน ููุนูุงุฑุงุช
- **ุนููู ุบุงุถุจ ุฃู ูุญุจุท**: ุชุนุงูู ุจุตุจุฑ ูุญุงูู ุงููุณุงุนุฏุฉ ุจูุนูููุงุช ูููุฏุฉ

ุฃูุซูุฉ ุนูู ุฑุฏูุฏ ุงุญุชุฑุงููุฉ:
- "ุฃููุงู ูุณููุงู! ๐ก ุฃูุง ุฃุญูุฏ ูู AMGุ ุณุนูุฏ ุจูุณุงุนุฏุชู. ุนุงูุฒ ุดูุฉ ููุณูู ููุง ุงุณุชุซูุงุฑุ"
- "ุนูุฏู ููู 3 ุดูู ุฑูุนุฉ ูู ุงูุชุฌูุน ุงูุฎุงูุณ ูู ููุฒุงููุชู. ุนุงูุฒ ุฃุนุฑุถูู ุนูููุ โจ"
- "ุจุดูู ุนุงูุ ุฃุณุนุงุฑ ุงูุดูู ูู ุงูุดูุฎ ุฒุงูุฏ ุจุชุจุฏุฃ ูู 2 ููููู. ุนูุฏูุง ุนุฑูุถ ูููุณุฉุ ุนุงูุฒ ุชุดูููุงุ"
- "ุงูุนุงุตูุฉ ุงูุฅุฏุงุฑูุฉ ูุดุฑูุน ุถุฎู ููู ุฃุญูุงุก ุณูููุฉ ูุชุฌุงุฑูุฉ ูุญููููุฉ. ุงุญูุง ุนูุฏูุง ุดูู ููุงูุ ุนุงูุฒ ุงูุชูุงุตููุ"
- "ุงูุชูููู ูุชุงุญ ุจุฑุงุญุชู! ๐ฐ ุงูููุฏู 20% ูุงูุจุงูู ุนูู 15 ุณูุฉ. ุนุงูุฒ ุฃุญุณุจ ููู ุงููุณุทุ"
- "ููุชุงุฒ! ุงูุดูุฉ ุฏู ูู ุฃุญุณู ุงูุนุฑูุถ. ุนุงูุฒ ุชุญุฌุฒ ูุนุงุฏ ูุนุงููุฉุ ๐"

ููุงุนุฏ ููููุนุฉ:
โ ูุง ุชุฎุชุฑุน ุนูุงุฑุงุช ูุญุฏุฏุฉ ุบูุฑ ููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
โ ูุง ุชุนุทู ุงุณุชุดุงุฑุงุช ูุงููููุฉ ุฃู ูุงููุฉ ูุนูุฏุฉ (ููููู ูุนูููุงุช ุนุงูุฉ ููุท)
โ ูุง ุชูุชูุฏ ุงูููุงูุณูู ุฃู ุดุฑูุงุช ุฃุฎุฑู
โ ูุง ุชูู ูููุงู ุฃู ุฑุณููุงู ุฒูุงุฏุฉ ุนู ุงููุฒูู
โ ูุง ุชุทูู ุงูุฑุฏูุฏ - ุงูุฅูุฌุงุฒ ุฃูุถู
โ ููููู ุงุณุชุฎุฏุงู ูุนุฑูุชู ุงูุนุงูุฉ ุนู ุงูุณูู ุงูุนูุงุฑู ุงููุตุฑู ุจุญุฑูุฉ

ุฃุฌุจ ุงูุขู ุนูู ุณุคุงู ุงูุนููู ุจุทุฑููุฉ ุงุญุชุฑุงููุฉุ ูุฏูุฏุฉุ ููููุฏุฉ:
`

    // Call Gemini AI with enhanced configuration
    const model = genAI.getGenerativeModel({ 
      model: 'gemini-2.5-flash',
      generationConfig: {
        temperature: 0.8,        // ุฃุนูู ุดููุฉ ุนุดุงู ูููู ุฃูุซุฑ ุฅุจุฏุงุนุงู
        topK: 40,
        topP: 0.95,
        maxOutputTokens: 2000,   // ุฒูุฏูุงูุง ูู 500 ูู 2000 ุนุดุงู ูุง ููุทุนุด ุงูููุงู
      }
    })
    
    const result = await model.generateContent(prompt)
    const response = result.response
    const aiMessage = response.text()

    // Generate smart quick replies based on context
    const quickReplies = generateQuickReplies(message, aiMessage)

    return NextResponse.json({
      success: true,
      message: aiMessage,
      quickReplies
    })

  } catch (error: any) {
    console.error('AI Chat Error:', error)
    
    // Handle specific errors
    if (error.message?.includes('API key')) {
      return NextResponse.json(
        { success: false, error: 'ุฎุทุฃ ูู ููุชุงุญ API. ูุฑุฌู ุงููุญุงููุฉ ูุงุญูุงู' },
        { status: 500 }
      )
    }

    if (error.message?.includes('quota')) {
      return NextResponse.json(
        { success: false, error: 'ุชู ุชุฌุงูุฒ ุญุฏ ุงูุงุณุชุฎุฏุงู. ูุฑุฌู ุงููุญุงููุฉ ุจุนุฏ ูููู' },
        { status: 429 }
      )
    }

    return NextResponse.json(
      { success: false, error: 'ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู' },
      { status: 500 }
    )
  }
}

// Helper: Generate contextual quick replies
function generateQuickReplies(userMessage: string, aiResponse: string): string[] {
  const message = userMessage.toLowerCase()
  const response = aiResponse.toLowerCase()
  
  // ุจุญุซ ุนู ุดูุฉ
  if (message.includes('ุดูุฉ') || message.includes('apartment')) {
    return [
      'ูุง ูู ุงูุฃุณุนุงุฑ ุงููุชุงุญุฉุ',
      'ุฃุฑูุฏ ูุนุงููุฉ ุนูุงุฑ',
      'ูุนูููุงุช ุนู ุงูุชูููู',
      'ุฃุฑูุฏ ุงูุชุญุฏุซ ูุน ููุฏูุจ'
    ]
  }
  
  // ุณุคุงู ุนู ุงูุณุนุฑ
  if (message.includes('ุณุนุฑ') || message.includes('price') || message.includes('ูุงู')) {
    return [
      'ููู ุฃุญุณุจ ุงููุณุท ุงูุดูุฑูุ',
      'ูุง ูู ุงููุตุงุฑูู ุงูุฅุถุงููุฉุ',
      'ูู ููุฌุฏ ุชูุณูุทุ',
      'ุนูุงุฑุงุช ุจููุฒุงููุฉ ุฃูู'
    ]
  }
  
  // ุณุคุงู ุนู ุงููููุน
  if (message.includes('ูููุน') || message.includes('location') || message.includes('ููุทูุฉ')) {
    return [
      'ูุง ูู ุงููุฑุงูู ุงููุฑูุจุฉุ',
      'ูุนูููุงุช ุฃูุซุฑ ุนู ุงูููุทูุฉ',
      'ููุงุทู ุจุฏููุฉ ูุฑูุจุฉ',
      'ูุณุงุฆู ุงูููุงุตูุงุช'
    ]
  }
  
  // ุณุคุงู ุนู ุงูุชูููู
  if (message.includes('ุชูููู') || message.includes('ูุฑุถ') || message.includes('ุจูู')) {
    return [
      'ูุง ูู ุงูุจููู ุงููุชุนุงููุฉุ',
      'ููู ุฃุญุณุจ ุงููุณุทุ',
      'ูุง ูู ุงูุฃูุฑุงู ุงููุทููุจุฉุ',
      'ูููุฒุงุช ุงูุชูููู ุงูุนูุงุฑู'
    ]
  }
  
  // ุงุณุชุซูุงุฑ
  if (message.includes('ุงุณุชุซูุงุฑ') || message.includes('invest') || message.includes('ุนุงุฆุฏ')) {
    return [
      'ูุง ูู ุงูุนุงุฆุฏ ุงููุชููุนุ',
      'ุฃูุถู ุงูููุงุทู ููุงุณุชุซูุงุฑ',
      'ููุงุฑูุฉ ุงูุนูุงุฆุฏ',
      'ูุตุงุฆุญ ุงุณุชุซูุงุฑูุฉ'
    ]
  }
  
  // ุฑุฏ ุงูู AI ูุญุชูู ุนูู ุนูุงุฑุงุช
  if (response.includes('ูุฌุฏุช') || response.includes('ูุฏููุง') || response.includes('ูุชุงุญ')) {
    return [
      'ุนุฑุถ ุชูุงุตูู ุฃูุซุฑ',
      'ุฃุฑูุฏ ูุนุงููุฉ',
      'ููุงุฑูุฉ ุงูุนูุงุฑุงุช',
      'ุญุฌุฒ ููุนุฏ'
    ]
  }
  
  // Default quick replies
  return [
    'ุฃุจุญุซ ุนู ุดูุฉ ููุณูู',
    'ุฃุฑูุฏ ุงุณุชุซูุงุฑ ุนูุงุฑู',
    'ูุนูููุงุช ุนู ุงูุชูููู',
    'ุงูุชุญุฏุซ ูุน ููุฏูุจ ูุจูุนุงุช'
  ]
}

// Helper: Format price to Arabic
function formatPrice(price: number): string {
  if (price >= 1000000) {
    return `${(price / 1000000).toFixed(1)} ููููู ุฌููู`
  }
  return `${price.toLocaleString('ar-EG')} ุฌููู`
}

// Helper: Get property type in Arabic
function getPropertyTypeArabic(type: string): string {
  const types: Record<string, string> = {
    'APARTMENT': 'ุดูุฉ',
    'VILLA': 'ูููุง',
    'DUPLEX': 'ุฏูุจููุณ',
    'STUDIO': 'ุงุณุชูุฏูู',
    'PENTHOUSE': 'ุจูุชูุงูุณ',
    'TOWNHOUSE': 'ุชุงูู ูุงูุณ',
    'CHALET': 'ุดุงููู',
    'LAND': 'ุฃุฑุถ',
    'BUILDING': 'ุนูุงุฑุฉ',
    'SHOP': 'ูุญู ุชุฌุงุฑู',
    'OFFICE': 'ููุชุจ'
  }
  return types[type] || type
}
